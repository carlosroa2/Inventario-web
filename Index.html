<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario Web con Login</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    #login { display: flex; justify-content: center; margin-top: 100px; }

    #app { display: none; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    table, th, td { border: 1px solid #ccc; padding: 10px; }

    input, button { padding: 8px; }

    .btn { cursor: pointer; }
    .btn:hover { opacity: .8; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <div id="g_id_onload"
      data-client_id="804049595544-me9tmvse7iggt39k99mufsn92cee1mac.apps.googleusercontent.com"
      data-context="signin"
      data-ux_mode="popup"
      data-callback="handleLogin"
      data-auto_prompt="false">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="sign_in_with"
       data-size="large">
  </div>
</div>

<!-- APLICACIÓN -->
<div id="app">
  <h1>Inventario</h1>

  <input
    type="text"
    id="buscar"
    placeholder="Buscar por nombre..."
    onkeyup="filtrarTabla()"
  />

  <button onclick="cargarInventario()" class="btn">Actualizar tabla</button>

  <table id="tabla">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Stock</th>
        <th>Precio</th>
        <th>Actualizar stock</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // =============== CONFIGURACIÓN ===============
  const API_URL = "https://script.google.com/a/macros/speedhub.cl/s/AKfycby24Jh92CnbJ287JDt5nEFN-kDqrCk_gW1uBzy725iFH7UkVvA1xM3-b7jMvdFqjR5Y/exec"; 
  const PERMITIDOS = ["tu_correo@gmail.com"]; // Agrega más si quieres

  // =============== LOGIN GOOGLE ===============
  function handleLogin(response) {
    const info = parseJwt(response.credential);
    const email = info.email;

    if (!PERMITIDOS.includes(email)) {
      alert("No tienes permiso para acceder.");
      document.body.innerHTML = "<h2>Acceso denegado</h2>";
      return;
    }

    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";

    cargarInventario();
  }

  function parseJwt(token) {
    return JSON.parse(atob(token.split('.')[1]));
  }

  // =============== INVENTARIO ===============
  async function cargarInventario() {
    const res = await fetch(API_URL);
    const productos = await res.json();

    const tbody = document.querySelector("#tabla tbody");
    tbody.innerHTML = "";

    productos.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.ID}</td>
        <td>${p.Nombre}</td>
        <td>${p.Categoría}</td>
        <td>${p.Stock}</td>
        <td>${p.Precio}</td>
        <td>
          <button class="btn" onclick="cambiarStock('${p.ID}', 1, 'entrada')">+1</button>
          <button class="btn" onclick="cambiarStock('${p.ID}', 1, 'salida')">-1</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function cambiarStock(id, cantidad, tipo) {
    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ id, cantidad, tipo })
    });
    cargarInventario();
  }

  // =============== BUSCADOR ===============
  function filtrarTabla() {
    const filtro = document.getElementById("buscar").value.toLowerCase();
    const filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach(row => {
      const nombre = row.children[1].textContent.toLowerCase();
      row.style.display = nombre.includes(filtro) ? "" : "none";
    });
  }
</script>

</body>
</html>
